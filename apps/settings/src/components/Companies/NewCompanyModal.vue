<!--
	- @copyright 2023 Christopher Ng <chrng8@gmail.com>
	-
	- @author Christopher Ng <chrng8@gmail.com>
	-
	- @license AGPL-3.0-or-later
	-
	- This program is free software: you can redistribute it and/or modify
	- it under the terms of the GNU Affero General Public License as
	- published by the Free Software Foundation, either version 3 of the
	- License, or (at your option) any later version.
	-
	- This program is distributed in the hope that it will be useful,
	- but WITHOUT ANY WARRANTY; without even the implied warranty of
	- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
	- GNU Affero General Public License for more details.
	-
	- You should have received a copy of the GNU Affero General Public License
	- along with this program. If not, see <http://www.gnu.org/licenses/>.
	-
-->

<template>
	<NcModal class="modal" size="small" v-on="$listeners">
		<form
			class="modal__form"
			data-test="form"
			:disabled="loading.all"
			@submit.prevent="createCompany"
		>
			<h2>新建公司</h2>
			<NcTextField
				ref="username"
				class="modal__item"
				data-test="username"
				:value.sync="newUser.id"
				label="公司名（必填）"
				:label-visible="true"
				autocapitalize="none"
				autocomplete="off"
				autocorrect="off"
				required
			/>
			<NcTextField
				class="modal__item"
				data-test="displayName"
				:value.sync="newUser.displayName"
				:label="t('settings', 'Display name')"
				:label-visible="true"
				autocapitalize="none"
				autocomplete="off"
				autocorrect="off"
			/>
			<NcPasswordField
				ref="password"
				class="modal__item"
				data-test="password"
				:value.sync="newUser.password"
				:minlength="minPasswordLength"
				:maxlength="469"
				aria-describedby="password-email-hint"
				:label="
					newUser.mailAddress === ''
						? t('settings', 'Password (required)')
						: t('settings', 'Password')
				"
				:label-visible="true"
				autocapitalize="none"
				autocomplete="new-password"
				autocorrect="off"
				:required="newUser.mailAddress === ''"
			/>
			<div class="modal__item">
				<label class="modal__label" for="new-user-quota">
					{{ t("settings", "Quota") }}
				</label>
				<NcSelect
					v-model="newUser.quota"
					class="modal__select"
					input-id="new-user-quota"
					:placeholder="t('settings', 'Set user quota')"
					:options="quotaOptions"
					:clearable="false"
					:taggable="true"
					:create-option="validateQuota"
				/>
			</div>
			<div v-if="showConfig.showLanguages" class="modal__item">
				<label class="modal__label" for="new-user-language">
					{{ t("settings", "Language") }}
				</label>
				<NcSelect
					v-model="newUser.language"
					class="modal__select"
					input-id="new-user-language"
					:placeholder="t('settings', 'Set default language')"
					:clearable="false"
					:selectable="(option) => !option.languages"
					:filter-by="languageFilterBy"
					:options="languages"
					label="name"
				/>
			</div>
			<NcTextField
				class="modal__item"
				data-test="displayName"
				:value.sync="newUser.adminUser"
				label="管理员账号 (必填)"
				:label-visible="true"
				autocapitalize="none"
				autocomplete="off"
				autocorrect="off"
				required
			/>
			<NcTextField
				class="modal__item"
				data-test="displayName"
				:value.sync="newUser.adminDisplayname"
				label="管理员显示名称"
				:label-visible="true"
				autocapitalize="none"
				autocomplete="off"
				autocorrect="off"
			/>
			<NcPasswordField
				class="modal__item"
				data-test="displayName"
				:value.sync="newUser.adminPassword"
				label="管理员密码 (必填)"
				:label-visible="true"
				autocapitalize="none"
				autocomplete="off"
				autocorrect="off"
				required
			/>
			<NcButton
				class="modal__submit"
				data-test="submit"
				type="primary"
				native-type="submit"
			>
				添加新公司
			</NcButton>
		</form>
	</NcModal>
</template>

<script>
import NcButton from "@nextcloud/vue/dist/Components/NcButton.js";
import NcModal from "@nextcloud/vue/dist/Components/NcModal.js";
import NcPasswordField from "@nextcloud/vue/dist/Components/NcPasswordField.js";
import NcSelect from "@nextcloud/vue/dist/Components/NcSelect.js";
import NcTextField from "@nextcloud/vue/dist/Components/NcTextField.js";

export default {
	name: "NewUserModal",

	components: {
		NcButton,
		NcModal,
		NcPasswordField,
		NcSelect,
		NcTextField,
	},

	props: {
		loading: {
			type: Object,
			required: true,
		},

		newUser: {
			type: Object,
			required: true,
		},

		quotaOptions: {
			type: Array,
			required: true,
		},
	},

	data() {
		return {
			possibleManagers: [],
			// TRANSLATORS This string describes a manager in the context of an organization
			managerLabel: t("settings", "Set user manager"),
		};
	},

	computed: {
		showConfig() {
			return this.$store.getters.getShowConfig;
		},

		settings() {
			return this.$store.getters.getServerData;
		},

		usernameLabel() {
			if (this.settings.newUserGenerateUserID) {
				return t("settings", "Username will be autogenerated");
			}
			return t("settings", "Username (required)");
		},

		minPasswordLength() {
			return this.$store.getters.getPasswordPolicyMinLength;
		},

		groups() {
			// data provided php side + remove the disabled group
			return this.$store.getters.getGroups
				.filter((group) => group.id !== "disabled")
				.sort((a, b) => a.name.localeCompare(b.name));
		},

		subAdminsGroups() {
			// data provided php side
			return this.$store.getters.getSubadminGroups;
		},

		canAddGroups() {
			// disabled if no permission to add new users to group
			return this.groups.map((group) => {
				// clone object because we don't want
				// to edit the original groups
				group = Object.assign({}, group);
				group.$isDisabled = group.canAdd === false;
				return group;
			});
		},

		languages() {
			return [
				{
					name: t("settings", "Common languages"),
					languages: this.settings.languages.commonLanguages,
				},
				...this.settings.languages.commonLanguages,
				{
					name: t("settings", "Other languages"),
					languages: this.settings.languages.otherLanguages,
				},
				...this.settings.languages.otherLanguages,
			];
		},
	},

	async beforeMount() {
		await this.searchUserManager();
	},

	methods: {
		async createCompany() {
			this.loading.all = true;
			try {
				await this.$store.dispatch("addCompany", {
					companyId: this.newUser.id,
					password: this.newUser.password,
					displayName: this.newUser.displayName,
					email: this.newUser.mailAddress,
					language: this.newUser.language.code,
					adminUser: this.newUser.adminUser,
					adminDisplayname: this.newUser.adminDisplayname,
					adminPassword: this.newUser.adminPassword,
				});

				this.$emit("reset");
				this.$refs.username?.$refs?.inputField?.$refs?.input?.focus?.();
				this.$emit("close");
			} catch (error) {
				this.loading.all = false;
				if (
					error.response &&
					error.response.data &&
					error.response.data.ocs &&
					error.response.data.ocs.meta
				) {
					const statuscode = error.response.data.ocs.meta.statuscode;
					if (statuscode === 102) {
						// wrong username
						this.$refs.username?.$refs?.inputField?.$refs?.input?.focus?.();
					} else if (statuscode === 107) {
						// wrong password
						this.$refs.password?.$refs?.inputField?.$refs?.input?.focus?.();
					}
				}
			}
		},

		handleGroupInput(groups) {
			/**
			 * Filter out groups with no id to prevent duplicate selected options
			 *
			 * Created groups are added programmatically by `createGroup()`
			 */
			this.newUser.groups = groups.filter((group) => Boolean(group.id));
		},

		/**
		 * Create a new group
		 *
		 * @param {any} group Group
		 * @param {string} group.name Group id
		 */
		async createGroup({ name: gid }) {
			this.loading.groups = true;
			try {
				await this.$store.dispatch("addGroup", gid);
				this.newUser.groups.push(this.groups.find((group) => group.id === gid));
				this.loading.groups = false;
			} catch (error) {
				this.loading.groups = false;
			}
		},

		/**
		 * Validate quota string to make sure it's a valid human file size
		 *
		 * @param {string} quota Quota in readable format '5 GB'
		 * @return {object}
		 */
		validateQuota(quota) {
			// only used for new presets sent through @Tag
			const validQuota = OC.Util.computerFileSize(quota);
			if (validQuota !== null && validQuota >= 0) {
				// unify format output
				quota = OC.Util.humanFileSize(OC.Util.computerFileSize(quota));
				this.newUser.quota = { id: quota, label: quota };
				return this.newUser.quota;
			}
			// Default is unlimited
			this.newUser.quota = this.quotaOptions[0];
			return this.quotaOptions[0];
		},

		languageFilterBy(option, label, search) {
			// Show group header of the language
			if (option.languages) {
				return option.languages.some(({ name }) =>
					name.toLocaleLowerCase().includes(search.toLocaleLowerCase())
				);
			}

			return (label || "")
				.toLocaleLowerCase()
				.includes(search.toLocaleLowerCase());
		},

		async searchUserManager(query) {
			await this.$store
				.dispatch("searchUsers", {
					offset: 0,
					limit: 10,
					search: query,
				})
				.then((response) => {
					const users = response?.data
						? Object.values(response?.data.ocs.data.users)
						: [];
					if (users.length > 0) {
						this.possibleManagers = users;
					}
				});
		},
	},
};
</script>

<style lang="scss" scoped>
.modal {
	&__form {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 20px;
		gap: 4px 0;

		/* fake input for groups validation */
		#new-user-groups-input {
			position: absolute;
			opacity: 0;
			/* The "hidden" input is behind the NcSelect, so in general it does
			* not receives clicks. However, with Firefox, after the validation
			* fails, it will receive the first click done on it, so its width needs
			* to be set to 0 to prevent that ("pointer-events: none" does not
			* prevent it). */
			width: 0;
		}
	}

	&__item {
		width: 100%;

		&:not(:focus):not(:active) {
			border-color: var(--color-border-dark);
		}
	}

	&__hint {
		color: var(--color-text-maxcontrast);
		margin-top: 8px;
		align-self: flex-start;
	}

	&__label {
		display: block;
		padding: 4px 0;
	}

	&__select {
		width: 100%;
	}

	&__submit {
		margin-top: 20px;
	}
}
</style>
